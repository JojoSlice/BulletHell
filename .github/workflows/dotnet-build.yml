name: Build on PR

on:
  pull_request:
    branches:
      - main
      - develop

permissions:
  contents: read
  pull-requests: write
  checks: write
  actions: write

jobs:
  build:
    name: Build on Ubuntu
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Count changed files and lines
        id: stats
        shell: bash
        run: |
          git fetch origin ${{ github.base_ref }}

          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | { grep '\.cs$' || true; } | wc -l)
          echo "changed_files=${CHANGED_FILES}" >> "${GITHUB_OUTPUT}"

          CHANGED_LINES=$(git diff --numstat origin/${{ github.base_ref }}...HEAD | { grep '\.cs$' || true; } | awk '{sum+=$1+$2} END {print sum+0}')
          echo "changed_lines=${CHANGED_LINES:-0}" >> "${GITHUB_OUTPUT}"

      - name: Show stats
        shell: bash
        run: |
          echo "üìä Statistik f√∂r C# filer:"
          echo "================================"
          echo "√Ñndrade filer: ${{ steps.stats.outputs.changed_files }}"
          echo "√Ñndrade rader: ${{ steps.stats.outputs.changed_lines }}"
          echo "================================"

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "9.0.x"

      - name: Install MonoGame dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libopenal-dev \
            libgl1-mesa-dev \
            libglu1-mesa-dev \
            xvfb

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ubuntu-nuget-${{ hashFiles('**/*.csproj', '**/packages.lock.json') }}
          restore-keys: |
            ubuntu-nuget-

      - name: Restore dependencies
        id: restore
        run: dotnet restore BulletHellSpaceShooter.sln

      - name: Check for vulnerable packages (collect report, don't fail job)
        id: vulnerability-check
        shell: bash
        run: |
          failedStep='Ok√§nt steg'
          errorDetails=''
        
          if [ "${RESTORE_OUTCOME}" = "failure" ]; then
            failedStep='Restore dependencies'
            errorDetails='Det gick inte att √•terst√§lla NuGet-paket. Kontrollera att alla paketversioner √§r giltiga.'
          elif [ "${BUILD_OUTCOME}" = "failure" ]; then
            failedStep='Build with Code Analysis'
            errorDetails='Build misslyckades. Detta kan bero p√•:\n- Kompileringsfel i koden\n- Code analysis varningar (behandlas som fel)\n- Syntaxfel'
          fi
        
          if [ "${BUILD_OUTCOME}" = "success" ]; then
            status_line='‚úÖ Build lyckades p√• Ubuntu!'
          else
            status_line='‚ùå Build misslyckades'
          fi
        
          if [ "${VULN}" = "true" ]; then
            vuln_summary='‚ö†Ô∏è S√•rbara NuGet-paket hittades ‚Äî fullst√§ndig lista nedan.'
          else
            vuln_summary='‚úÖ Inga s√•rbara NuGet-paket hittades'
          fi
        
          VULN_REPORT_FILE="vulnerability-report.txt"
          VULN_CONTENT=""
          TRUNCATED_NOTICE=""
        
          if [ -f "${VULN_REPORT_FILE}" ]; then
            VULN_CONTENT=$(head -c 12000 "${VULN_REPORT_FILE}" || true)
            TOTAL_SIZE=$(wc -c < "${VULN_REPORT_FILE}" || echo 0)
            RETAINED_SIZE=$(printf "%s" "$VULN_CONTENT" | wc -c)
            if [ "${TOTAL_SIZE}" -gt "${RETAINED_SIZE}" ]; then
              TRUNCATED_NOTICE="_(Rapport f√∂rkortad ‚Äî se artifact eller k√∂rningsloggar f√∂r hela inneh√•llet)_"
            fi
          else
            VULN_CONTENT="Inga data (vulnerability-report.txt saknas)."
          fi
        
          {
            echo "## üìä Build Statistik"
            echo
            echo "${status_line}"
            echo
            echo "### √Ñndringar i denna PR:"
            echo "- **√Ñndrade .cs filer:** ${CHANGED_FILES}"
            echo "- **√Ñndrade rader:** ${CHANGED_LINES}"
            echo
            echo "${vuln_summary}"
            echo
        
            if [ "${VULN}" = "true" ]; then
              echo "### S√•rbara paket (utdrag)"
              echo '```'
              printf '%s\n' "${VULN_CONTENT}"
              echo '```'
              echo
              echo "${TRUNCATED_NOTICE}"
              echo
            fi
        
            if [ "${BUILD_OUTCOME}" != "success" ]; then
              echo "**Steg som failade:** ${failedStep}"
              echo
              echo "**Detaljer:** ${errorDetails}"
              echo
              echo "[Se fullst√§ndiga loggar h√§r](${SERVER_URL}/${REPO}/actions/runs/${RUN_ID})"
            fi
          } > comment.md

      - name: Create or update sticky PR comment with build statistics and vulnerabilities
        if: always()
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body-file: comment.md
          identifier: build-statistics

  run-tests:
    needs: build
    uses: ./.github/workflows/test-on-build.yml
    with:
      pr_number: ${{ github.event.pull_request.number }}
      commit_sha: ${{ github.sha }}
