name: Build on PR

on:
  pull_request:
    branches:
      - main
      - develop

permissions:
  contents: read
  pull-requests: write
  checks: write
  actions: write

jobs:
  build:
    name: Build on Ubuntu
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Count changed files and lines
        id: stats
        shell: bash
        run: |
          git fetch origin ${{ github.base_ref }}

          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | { grep '\.cs$' || true; } | wc -l)
          echo "changed_files=${CHANGED_FILES}" >> "${GITHUB_OUTPUT}"

          CHANGED_LINES=$(git diff --numstat origin/${{ github.base_ref }}...HEAD | { grep '\.cs$' || true; } | awk '{sum+=$1+$2} END {print sum+0}')
          echo "changed_lines=${CHANGED_LINES:-0}" >> "${GITHUB_OUTPUT}"

      - name: Show stats
        shell: bash
        run: |
          echo "üìä Statistik f√∂r C# filer:"
          echo "================================"
          echo "√Ñndrade filer: ${{ steps.stats.outputs.changed_files }}"
          echo "√Ñndrade rader: ${{ steps.stats.outputs.changed_lines }}"
          echo "================================"

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "9.0.x"

      - name: Install MonoGame dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libopenal-dev \
            libgl1-mesa-dev \
            libglu1-mesa-dev \
            xvfb

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ubuntu-nuget-${{ hashFiles('**/*.csproj', '**/packages.lock.json') }}
          restore-keys: |
            ubuntu-nuget-

      - name: Restore dependencies
        id: restore
        run: dotnet restore BulletHellSpaceShooter.sln

      - name: Check for vulnerable packages (collect report, don't fail job)
        id: vulnerability-check
        shell: bash
        run: |
          echo "Checking for vulnerable NuGet packages..."
          # Collect the report even if empty
          dotnet list package --vulnerable --include-transitive 2>&1 | tee vulnerability-report.txt || true

          if grep -q "has the following vulnerable packages" vulnerability-report.txt; then
            echo "has_vulnerabilities=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è S√•rbara paket hittades!"
          else
            echo "has_vulnerabilities=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Inga s√•rbara paket hittades"
          fi

      - name: Build with Code Analysis
        id: dotnet_build
        run: dotnet build BulletHellSpaceShooter.sln --configuration Release --no-restore /p:TreatWarningsAsErrors=true

      - name: Build results
        if: success()
        shell: bash
        run: |
          echo "‚úÖ Build lyckades p√• Ubuntu!"
          echo "√Ñndrade ${{ steps.stats.outputs.changed_files }} filer med ${{ steps.stats.outputs.changed_lines }} rader"

      # Generate a single "sticky" comment body regardless of outcome (includes vulnerability report)
      - name: Generate sticky comment body (includes vulnerability report)
        if: always()
        shell: bash
        run: |
          # Capture values via expanded GitHub expressions into shell variables.
          # Doing it this way avoids timing/evaluation issues when using `env:` with step outcomes.
          BUILD_OUTCOME="${{ steps.dotnet_build.outcome }}"
          RESTORE_OUTCOME="${{ steps.restore.outcome }}"
          VULN="${{ steps.vulnerability-check.outputs.has_vulnerabilities }}"
          CHANGED_FILES="${{ steps.stats.outputs.changed_files }}"
          CHANGED_LINES="${{ steps.stats.outputs.changed_lines }}"
          RUN_ID="${{ github.run_id }}"
          REPO="${{ github.repository }}"
          SERVER_URL="${{ github.server_url }}"

          # Provide safe defaults
          CHANGED_FILES="${CHANGED_FILES:-0}"
          CHANGED_LINES="${CHANGED_LINES:-0}"

          failedStep='Ok√§nt steg'
          errorDetails=''

          if [ "${RESTORE_OUTCOME}" = "failure" ]; then
            failedStep='Restore dependencies'
            errorDetails='Det gick inte att √•terst√§lla NuGet-paket. Kontrollera att alla paketversioner √§r giltiga.'
          elif [ "${BUILD_OUTCOME}" = "failure" ]; then
            failedStep='Build with Code Analysis'
            errorDetails='Build misslyckades. Detta kan bero p√•:\n- Kompileringsfel i koden\n- Code analysis varningar (behandlas som fel)\n- Syntaxfel'
          fi

          if [ "${BUILD_OUTCOME}" = "success" ]; then
            status_line='‚úÖ Build lyckades p√• Ubuntu!'
          else
            status_line='‚ùå Build misslyckades'
          fi

          if [ "${VULN}" = "true" ]; then
            vuln_summary='‚ö†Ô∏è S√•rbara NuGet-paket hittades ‚Äî fullst√§ndig lista nedan.'
          else
            vuln_summary='‚úÖ Inga s√•rbara NuGet-paket hittades'
          fi

          # Prepare vulnerability report (truncate to avoid huge comments)
          VULN_REPORT_FILE="vulnerability-report.txt"
          VULN_CONTENT=""
          TRUNCATED_NOTICE=""

          if [ -f "${VULN_REPORT_FILE}" ]; then
            # Strip any leading/trailing whitespace and detect size
            # Keep at most 12000 characters to be safe for comment limits
            VULN_CONTENT=$(head -c 12000 "${VULN_REPORT_FILE}" || true)
            TOTAL_SIZE=$(wc -c < "${VULN_REPORT_FILE}" || echo 0)
            RETAINED_SIZE=$(printf "%s" "$VULN_CONTENT" | wc -c)
            if [ "${TOTAL_SIZE}" -gt "${RETAINED_SIZE}" ]; then
              TRUNCATED_NOTICE="_(Rapport f√∂rkortad ‚Äî se artifact eller k√∂rningsloggar f√∂r hela inneh√•llet)_"
            fi
          else
            VULN_CONTENT="Inga data (vulnerability-report.txt saknas)."
          fi
          {
              echo "## üìä Build Statistik"
              echo
              echo "${status_line}"
              echo
              echo "### √Ñndringar i denna PR:"
              echo "- **√Ñndrade .cs filer:** ${CHANGED_FILES}"
              echo "- **√Ñndrade rader:** ${CHANGED_LINES}"
              echo
              echo "${vuln_summary}"
              echo
          
              if [ "${VULN}" = "true" ]; then
                echo "### S√•rbara paket (utdrag)"
                echo '```'
                printf '%s\n' "${VULN_CONTENT}"
                echo '```'
                echo
                echo "${TRUNCATED_NOTICE}"
                echo
              fi
          
              if [ "${BUILD_OUTCOME}" != "success" ]; then
                echo "**Steg som failade:** ${failedStep}"
                echo
                echo "**Detaljer:** ${errorDetails}"
                echo
                echo "[Se fullst√§ndiga loggar h√§r](${SERVER_URL}/${REPO}/actions/runs/${RUN_ID})"
              fi
            } > comment.md

      - name: Create or update sticky PR comment
        uses: marocchino/sticky-pull-request-comment@v2.9.0
        if: always()
        with:
          recreate: true
          path: comment.md
          number: ${{ github.event.workflow_run.pull_requests[0].number }}

  run-tests:
    needs: build
    uses: ./.github/workflows/test-on-build.yml
    with:
      pr_number: ${{ github.event.pull_request.number }}
      commit_sha: ${{ github.sha }}
