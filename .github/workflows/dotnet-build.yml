name: Build on PR

on:
  pull_request:
    branches:
      - main
      - develop

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  build:
    name: Build on Ubuntu
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Count changed files and lines
        id: stats
        shell: bash
        run: |
          git fetch origin ${{ github.base_ref }}

          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | { grep '\.cs$' || true; } | wc -l)
          echo "changed_files=${CHANGED_FILES}" >> "${GITHUB_OUTPUT}"

          CHANGED_LINES=$(git diff --numstat origin/${{ github.base_ref }}...HEAD | { grep '\.cs$' || true; } | awk '{sum+=$1+$2} END {print sum+0}')
          echo "changed_lines=${CHANGED_LINES:-0}" >> "${GITHUB_OUTPUT}"

      - name: Show stats
        shell: bash
        run: |
          echo "üìä Statistik f√∂r C# filer:"
          echo "================================"
          echo "√Ñndrade filer: ${{ steps.stats.outputs.changed_files }}"
          echo "√Ñndrade rader: ${{ steps.stats.outputs.changed_lines }}"
          echo "================================"

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "9.0.x"

      - name: Install MonoGame dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libopenal-dev \
            libgl1-mesa-dev \
            libglu1-mesa-dev \
            xvfb

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ubuntu-nuget-${{ hashFiles('**/*.csproj', '**/packages.lock.json') }}
          restore-keys: |
            ubuntu-nuget-

      - name: Restore dependencies
        id: restore
        run: dotnet restore BulletHellSpaceShooter.sln

      - name: Check for vulnerable packages
        id: vulnerability-check
        continue-on-error: false
        run: |
          echo "Checking for vulnerable NuGet packages..."
          dotnet list package --vulnerable --include-transitive 2>&1 | tee vulnerability-report.txt

          if grep -q "has the following vulnerable packages" vulnerability-report.txt; then
            echo "has_vulnerabilities=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è S√•rbara paket hittades!"
            exit 1
          else
            echo "has_vulnerabilities=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Inga s√•rbara paket hittades"
          fi

      - name: Comment on vulnerabilities
        if: steps.vulnerability-check.outputs.has_vulnerabilities == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const vulnReport = fs.readFileSync('vulnerability-report.txt', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ‚ö†Ô∏è S√•rbara NuGet-paket hittades\n\n` +
                    `F√∂ljande s√•rbara paket uppt√§cktes i projektet:\n\n` +
                    `\`\`\`\n${vulnReport}\n\`\`\`\n\n` +
                    `V√§nligen uppdatera dessa paket till s√§kra versioner.`
            });

      - name: Build with Code Analysis
        id: build
        run: dotnet build BulletHellSpaceShooter.sln --configuration Release --no-restore /p:TreatWarningsAsErrors=true

      - name: Run tests
        id: test
        env:
          DISPLAY: :99
        run: |
          # Start virtual display for MonoGame tests
          Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
          sleep 2

          dotnet test BulletHellSpaceShooter.sln \
            --configuration Release \
            --no-build \
            --verbosity normal \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults \
            --logger "trx" \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=cobertura

      - name: List test results (debug)
        if: always()
        run: |
          echo "Contents of TestResults directory:"
          ls -laR TestResults/ || echo "TestResults directory not found"
          echo ""
          echo "Looking for TRX files:"
          find TestResults -name "*.trx" -type f 2>/dev/null || echo "No TRX files found"
          echo ""
          echo "Looking for coverage files:"
          find TestResults -name "coverage.cobertura.xml" -type f 2>/dev/null || echo "No coverage files found"

      - name: Code Coverage Report
        id: coverage
        if: always() && steps.test.outcome != 'skipped'
        continue-on-error: true
        uses: irongut/CodeCoverageSummary@v1.3.0
        with:
          filename: TestResults/**/coverage.cobertura.xml
          badge: true
          fail_below_min: true
          format: markdown
          hide_branch_rate: false
          hide_complexity: true
          indicators: true
          output: both
          thresholds: '70 85'

      - name: Add Coverage PR Comment
        if: github.event_name == 'pull_request' && steps.coverage.outcome == 'success'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          recreate: true
          path: code-coverage-results.md

      - name: Test Report
        uses: dorny/test-reporter@v2
        if: always() && steps.test.outcome != 'skipped'
        continue-on-error: true
        with:
          name: .NET Tests
          path: TestResults/**/*.trx
          reporter: dotnet-trx
          fail-on-error: false

      - name: Build results
        if: success()
        shell: bash
        run: |
          echo "‚úÖ Build och tester lyckades p√• Ubuntu!"
          echo "√Ñndrade ${{ steps.stats.outputs.changed_files }} filer med ${{ steps.stats.outputs.changed_lines }} rader"

      - name: Comment PR on failure
        if: failure() && steps.vulnerability-check.outputs.has_vulnerabilities != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            let failedStep = 'Ok√§nt steg';
            let errorDetails = '';

            if ('${{ steps.restore.outcome }}' === 'failure') {
              failedStep = 'Restore dependencies';
              errorDetails = 'Det gick inte att √•terst√§lla NuGet-paket. Kontrollera att alla paketversioner √§r giltiga.';
            } else if ('${{ steps.build.outcome }}' === 'failure') {
              failedStep = 'Build with Code Analysis';
              errorDetails = 'Build misslyckades. Detta kan bero p√•:\n- Kompileringsfel i koden\n- Code analysis varningar (behandlas som fel)\n- Syntaxfel';
            } else if ('${{ steps.test.outcome }}' === 'failure') {
              failedStep = 'Run tests';
              errorDetails = 'Ett eller flera tester misslyckades. Kontrollera:\n- Att alla tester passerar lokalt\n- Testloggar f√∂r detaljer om vilka tester som failade\n- Om det finns nya breaking changes';
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ‚ùå Build Misslyckades\n\n` +
                    `**Steg som failade:** ${failedStep}\n\n` +
                    `**Detaljer:** ${errorDetails}\n\n` +
                    `[Se fullst√§ndiga loggar h√§r](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`
            })

      - name: Comment PR
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üìä Build Statistik\n\n` +
                    `‚úÖ Build och tester lyckades p√• Ubuntu!\n\n` +
                    `### √Ñndringar i denna PR:\n` +
                    `- **√Ñndrade .cs filer:** ${{ steps.stats.outputs.changed_files }}\n` +
                    `- **√Ñndrade rader:** ${{ steps.stats.outputs.changed_lines }}\n\n` +
                    `‚ú® Code analysis: Inga varningar eller fel\n` +
                    `‚úÖ Alla tester passerade`
            })
